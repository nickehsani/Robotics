import picamera
import picamera.array
import time
import cv2
import numpy as np
import smtplib,ssl
from email.mime.multipart import MIMEMultipart  
from email.mime.base import MIMEBase  
from email.mime.text import MIMEText  
from email.utils import formatdate  
from email import encoders 


camera = picamera.PiCamera()
camera.resolution = (640, 480)
camera.framerate = 60
camera.vflip = False
camera.hflip = True


rawframe = picamera.array.PiRGBArray(camera, size = (640,480))

def nothing(x):
    pass

time.sleep(1)


# Main Program

if __name__ == '__main__':
    try:

        # Video stream that will only display red objects
        for frame in camera.capture_continuous(rawframe, format = "bgr", use_video_port = True):

            rawframe.truncate(0)

            image = frame.array

            blurred_masked = cv2.GaussianBlur(image, (5,5), 0) 

            image_hsv = cv2.cvtColor(blurred_masked, cv2.COLOR_BGR2HSV)

            lower_red = np.array([0, 153, 41])
            upper_red = np.array([255, 255, 255])

            ourmask = cv2.inRange(image_hsv, lower_red, upper_red)

            image_masked = cv2.bitwise_and(image, image, mask = ourmask)

            _, contours, _ = cv2.findContours(ourmask, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)

            cv2.drawContours(image, contours, -1, (0,255,0), 3)

            cv2.imshow("Masked image", image_masked)
            cv2.imshow("blurred image", blurred_masked)
            cv2.imshow("image", image)

            area = cv2.contourArea()

            cv2.waitKey(1)

            if area > 100:
                camera.capture( 'RedDetection.jpg')
                def send_an_email():  
                    toaddr = 'chris.velasquez511@gmail.com'      # To id 
                    me = 'chris.velasquez511@gmail.com'          # your id
                    subject = "Security Footage"              # Subject
                
                    msg = MIMEMultipart()  
                    msg['Subject'] = subject  
                    msg['From'] = me  
                    msg['To'] = toaddr  
                    msg.preamble = "test "   
                    #msg.attach(MIMEText(text))  
                
                    part = MIMEBase('application', "octet-stream")  
                    part.set_payload(open("reddetection.jpg", "rb").read())  
                    encoders.encode_base64(part)  
                    part.add_header('Content-Disposition', 'attachment; filename="reddetection.jpg"')   # File name and format name
                    msg.attach(part)  
                
                    try:  
                    s = smtplib.SMTP('smtp.gmail.com', 587)  # Protocol
                    s.ehlo()  
                    s.starttls()  
                    s.ehlo()  
                    s.login(user = 'chris.velasquez511@gmail.com', password = 'chris1135952840')  # User id & password
                    #s.send_message(msg)  
                    s.sendmail(me, toaddr, msg.as_string())  
                    s.quit()  
                    #except:  
                    #   print ("Error: unable to send email")    
                    except SMTPException as error:  
                        print ("Error")                # Exception
  
                send_an_email()
                
                time.sleep(5)


    except KeyboardInterrupt:
        print("Program stopped by User")
        cv2.destroyAllWindows()
        camera.close()
